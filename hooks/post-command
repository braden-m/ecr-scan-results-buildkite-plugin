#! /bin/bash
set -euo pipefail

# check all inputs exist and are valid
image_name_pattern="^[0-9]{12}\.dkr\.ecr\.[a-z][a-z1-9-]+\.amazonaws.com/[^:]+:[^:]+$"
count_pattern="(^$)|(^[0-9]+$)"
if [ -n "${BUILDKITE_PLUGIN_ECR_SCAN_RESULTS_IMAGE_NAME}" ]
then
    IMAGE_NAME="${BUILDKITE_PLUGIN_ECR_SCAN_RESULTS_IMAGE_NAME}"
    if [[ ! "${IMAGE_NAME}" =~ ${image_name_pattern} ]]
    then
        annotation=$(printf "Error: value for IMAGE_NAME must be of the form AWS_ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com/REPOSITORY_NAME:IMAGE_TAG with the text in capitals replaced with the appropriate values.\n")
        buildkite-agent annotate --style error --context exit_reason "${annotation}"
        exit 1
    fi
else
    annotation=$(printf "Error: no value for IMAGE_NAME configured.\n")
    buildkite-agent annotate --style error --context exit_reason "${annotation}"
    exit 1
fi
if [[ -n "${BUILDKITE_PLUGIN_ECR_SCAN_RESULTS_MAX_CRITICALS+x}" ]]
then
    MAX_CRITICALS="${BUILDKITE_PLUGIN_ECR_SCAN_RESULTS_MAX_CRITICALS}"
    if [[ ! "${MAX_CRITICALS}" =~ ${count_pattern} ]]
    then
        annotation=$(printf "Error: value for MAX_CRITICALS must be an empty string or a string containing a non-negative integer.\n")
        buildkite-agent annotate --style error --context exit_reason "${annotation}"
        exit 1
    fi
else
    MAX_CRITICALS="0"
fi
if [[ -n "${BUILDKITE_PLUGIN_ECR_SCAN_RESULTS_MAX_HIGHSi+x}" ]]
then
    MAX_HIGHS="${BUILDKITE_PLUGIN_ECR_SCAN_RESULTS_MAX_HIGHS}"
    if [[ ! "${MAX_HIGHS}" =~ ${count_pattern} ]]
    then
        annotation=$(printf "Error: value for MAX_HIGHS must be an empty string or a string containing a non-negative integer.\n")
        buildkite-agent annotate --style error --context exit_reason "${annotation}"
        exit 1
    fi
else
    MAX_HIGHS="0"
fi

# print input values
echo "IMAGE_NAME=${IMAGE_NAME}"
echo "MAX_CRITICALS=${MAX_CRITICALS}"
echo "MAX_HIGHS=${MAX_HIGHS}"

FULL_REPO_NAME="${IMAGE_NAME%:*}"
REPO_NAME="${FULL_REPO_NAME#*/}"
IMAGE_TAG="${IMAGE_NAME#*:}"
IFS="." read -ra dot_fields <<< "${IMAGE_NAME}"
REPOSITORY_ID="${dot_fields[0]}"
REGION="${dot_fields[3]}"

# poll until scan is COMPLETE or FAILED
scan_status="IN_PROGRESS"
i="0"
while [ "${scan_status}" = "IN_PROGRESS" ]  && [ "$i" -le "100" ]
do
    scan_status=$(aws ecr describe-images \
        --registry-id "${REPOSITORY_ID}" \
        --repository-name "${REPO_NAME}" \
        --image-ids imageTag="${IMAGE_TAG}" \
        --query "imageDetails[0].imageScanStatus.status" \
        --output text)
    sleep 3
    ((i=i+1))
done

# retrieve counts of criticals and highs or fail build if scan failed
case "${scan_status}" in
    "COMPLETE")
        criticals=$(aws ecr describe-images \
            --registry-id "${REPOSITORY_ID}" \
            --repository-name "${REPO_NAME}" \
            --image-ids imageTag="${IMAGE_TAG}" \
            --query "imageDetails[0].imageScanFindingsSummary.findingSeverityCounts.CRITICAL" \
            --output text)
        highs=$(aws ecr describe-images \
            --registry-id "${REPOSITORY_ID}" \
            --repository-name "${REPO_NAME}" \
            --image-ids imageTag="${IMAGE_TAG}" \
            --query "imageDetails[0].imageScanFindingsSummary.findingSeverityCounts.HIGH" \
            --output text)
        image_digest=$(aws ecr describe-images \
            --registry-id "${REPOSITORY_ID}" \
            --repository-name "${REPO_NAME}" \
            --image-ids imageTag="${IMAGE_TAG}" \
            --query "imageDetails[0].imageDigest" \
            --output text)
        ;;
    *)
        annotation=$(printf "Error: ECR vulnerability scan failed with status: %s\n" "${scan_status}")
        buildkite-agent annotate --style error --context exit_reason "${annotation}"
        exit 1
        ;;
esac

# report results
vuln_url=$(printf "https://%s.console.aws.amazon.com/ecr/repositories/private/%s/%s/image/%s/scan-results/?region=%s" "${REGION}" "${REPOSITORY_ID}" "${REPO_NAME}" "${image_digest}" "${REGION}")
annotation=$(printf "%4d Critical vulnerabilities<br />%4d High vulnerabilities<br />Browse to <a href=\"%s\">image vulnerabilities</a> when logged into the appropriate AWS account with ecr:DescribeImages and ecr:DescribeImageScanFindings permissions" "${criticals}" "${highs}" "${vuln_url}")
buildkite-agent annotate --style info --context vuln_counts "${annotation}"

# check if thresholds are exceeded and if so fail build
fail_build="false"
annotation=""
if [ -n "${MAX_CRITICALS}" ] && [ "${criticals}" -gt "${MAX_CRITICALS}" ]
then
    annotation=$(printf "%sNumber of critical vulnerabilities exceeds threshold MAX_CRITICALS=%d<br />" "${annotation}" "${MAX_CRITICALS}")
    fail_build="true"
fi
if  [ -n "${MAX_HIGHS}" ] && [ "${highs}" -gt "${MAX_HIGHS}" ]
then
    annotation=$(printf "%sNumber of high vulnerabilities exceeds threshold MAX_HIGHS=%d<br />" "${annotation}" "${MAX_HIGHS}")
    fail_build="true"
fi
if  [ "${fail_build}" = "true" ]
then
    buildkite-agent annotate --style error --context fail_reason "${annotation}"
    exit 1
fi
